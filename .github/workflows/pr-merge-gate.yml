name: pr-merge-gate

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  actions: read
  contents: read
  pull-requests: read

jobs:
  gate:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Wait for required pipelines
        uses: actions/github-script@v8
        with:
          script: |
            const requiredWorkflows = ["ci", "security", "codeql"];
            const timeoutMs = 35 * 60 * 1000;
            const pollMs = 15 * 1000;
            const startedAt = Date.now();
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headSha = context.payload.pull_request.head.sha;

            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            while (true) {
              const { data } = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                event: "pull_request",
                head_sha: headSha,
                per_page: 100
              });

              const latestRunByName = new Map();
              for (const run of data.workflow_runs) {
                if (!requiredWorkflows.includes(run.name)) {
                  continue;
                }

                const previous = latestRunByName.get(run.name);
                if (!previous || new Date(run.created_at) > new Date(previous.created_at)) {
                  latestRunByName.set(run.name, run);
                }
              }

              const pending = [];
              const failed = [];
              const succeeded = [];

              for (const workflowName of requiredWorkflows) {
                const run = latestRunByName.get(workflowName);
                if (!run) {
                  pending.push(`${workflowName}: not started`);
                  continue;
                }

                if (run.status !== "completed") {
                  pending.push(`${workflowName}: ${run.status}`);
                  continue;
                }

                if (run.conclusion !== "success") {
                  failed.push(`${workflowName}: ${run.conclusion ?? "unknown"} (${run.html_url})`);
                  continue;
                }

                succeeded.push(workflowName);
              }

              if (failed.length > 0) {
                core.setFailed(`PR blocked: failing pipeline(s): ${failed.join(" | ")}`);
                return;
              }

              if (pending.length === 0) {
                core.info(`All required pipelines succeeded: ${succeeded.join(", ")}`);
                return;
              }

              if (Date.now() - startedAt > timeoutMs) {
                core.setFailed(`Timed out waiting for required pipelines: ${pending.join(" | ")}`);
                return;
              }

              core.info(`Waiting for pipelines: ${pending.join(" | ")}`);
              await sleep(pollMs);
            }
