name: security

on:
  pull_request:
    branches:
      - main

jobs:
  scans:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
          cache: true
          cache-dependency-path: |
            **/*.csproj
            **/packages.lock.json

      - name: Restore
        run: dotnet restore BloodWatch.sln

      - name: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check vulnerable NuGet packages
        run: |
          set -euo pipefail
          dotnet list BloodWatch.sln package --vulnerable --include-transitive --format json > vulnerability-report.json
          if jq -e '[.. | objects | .vulnerabilities? // empty | .[]?] | length > 0' vulnerability-report.json > /dev/null; then
            echo "Vulnerable packages were detected:"
            jq '[.. | objects | select((.vulnerabilities? | type) == "array" and (.vulnerabilities | length > 0)) | {id: .id, resolvedVersion: .resolvedVersion, vulnerabilities: .vulnerabilities}]' vulnerability-report.json
            exit 1
          fi

      - name: Guard tracked config secrets
        run: |
          set -euo pipefail

          db_connection_string="$(jq -r '.ConnectionStrings.BloodWatch // ""' src/BloodWatch.Api/appsettings.json)"
          if [ -n "$db_connection_string" ]; then
            echo "appsettings.json must not contain a committed ConnectionStrings.BloodWatch value."
            exit 1
          fi

          signing_key="$(jq -r '.BloodWatch.JwtAuth.SigningKey // ""' src/BloodWatch.Api/appsettings.json)"
          if [ -n "$signing_key" ]; then
            echo "appsettings.json must not contain a committed JWT signing key."
            exit 1
          fi

          admin_email="$(jq -r '.BloodWatch.JwtAuth.AdminEmail // ""' src/BloodWatch.Api/appsettings.json)"
          if [ -n "$admin_email" ]; then
            echo "appsettings.json must not contain a committed JWT admin email."
            exit 1
          fi

          admin_password_hash="$(jq -r '.BloodWatch.JwtAuth.AdminPasswordHash // ""' src/BloodWatch.Api/appsettings.json)"
          if [ -n "$admin_password_hash" ]; then
            echo "appsettings.json must not contain a committed JWT admin password hash."
            exit 1
          fi

          compose_signing_key="$(awk -F': ' '/BloodWatch__JwtAuth__SigningKey:/ {print $2; exit}' docker-compose.yml | tr -d '"\r')"
          if [ -n "$compose_signing_key" ] && [[ "$compose_signing_key" != *'${'* ]]; then
            echo "docker-compose.yml must not contain a raw BloodWatch__JwtAuth__SigningKey value."
            exit 1
          fi

          compose_admin_hash="$(awk -F': ' '/BloodWatch__JwtAuth__AdminPasswordHash:/ {print $2; exit}' docker-compose.yml | tr -d '"\r')"
          if [ -n "$compose_admin_hash" ] && [[ "$compose_admin_hash" != *'${'* ]]; then
            echo "docker-compose.yml must not contain a raw BloodWatch__JwtAuth__AdminPasswordHash value."
            exit 1
          fi

          prod_compose_signing_key="$(awk -F': ' '/BloodWatch__JwtAuth__SigningKey:/ {print $2; exit}' deploy/docker-compose.prod.yml | tr -d '"\r')"
          if [ -n "$prod_compose_signing_key" ] && [[ "$prod_compose_signing_key" != *'${'* ]]; then
            echo "deploy/docker-compose.prod.yml must not contain a raw BloodWatch__JwtAuth__SigningKey value."
            exit 1
          fi

          prod_compose_admin_hash="$(awk -F': ' '/BloodWatch__JwtAuth__AdminPasswordHash:/ {print $2; exit}' deploy/docker-compose.prod.yml | tr -d '"\r')"
          if [ -n "$prod_compose_admin_hash" ] && [[ "$prod_compose_admin_hash" != *'${'* ]]; then
            echo "deploy/docker-compose.prod.yml must not contain a raw BloodWatch__JwtAuth__AdminPasswordHash value."
            exit 1
          fi

          env_example_signing_key="$(awk -F'=' '/^BloodWatch__JwtAuth__SigningKey=/ {print $2; exit}' .env.example | tr -d '\r')"
          if [ -n "$env_example_signing_key" ]; then
            echo ".env.example must not contain a raw BloodWatch__JwtAuth__SigningKey value."
            exit 1
          fi

          env_example_connection_string="$(awk -F'=' '/^ConnectionStrings__BloodWatch=/ {print $2; exit}' .env.example | tr -d '\r')"
          if [ -n "$env_example_connection_string" ]; then
            echo ".env.example must not contain a raw ConnectionStrings__BloodWatch value."
            exit 1
          fi

          env_example_admin_hash="$(awk -F'=' '/^BloodWatch__JwtAuth__AdminPasswordHash=/ {print $2; exit}' .env.example | tr -d '\r')"
          if [ -n "$env_example_admin_hash" ]; then
            echo ".env.example must not contain a raw BloodWatch__JwtAuth__AdminPasswordHash value."
            exit 1
          fi

          env_example_postgres_password="$(awk -F'=' '/^POSTGRES_PASSWORD=/ {print $2; exit}' .env.example | tr -d '\r')"
          if [ -n "$env_example_postgres_password" ]; then
            echo ".env.example must not contain a raw POSTGRES_PASSWORD value."
            exit 1
          fi

          env_example_telegram_token="$(awk -F'=' '/^BLOODWATCH__TELEGRAM_BOT_TOKEN=/ {print $2; exit}' .env.example | tr -d '\r')"
          if [ -n "$env_example_telegram_token" ]; then
            echo ".env.example must not contain a raw BLOODWATCH__TELEGRAM_BOT_TOKEN value."
            exit 1
          fi
